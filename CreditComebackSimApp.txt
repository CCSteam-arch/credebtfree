<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CreDebtFree | Credit Simulator</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM via CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Babel for JSX Transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase Libraries via CDN -->
    <script type="module">
        // Firebase App (the core)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Firebase Authentication
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; // Added signInWithCustomToken
        // Firebase Firestore (Database)
        import { getFirestore, addDoc, collection, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase functions to the global scope
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getFirestore, addDoc, collection, serverTimestamp, setLogLevel
        };
    </script>

    <style>
        /* Custom styles from new design */
        .range-thumb-blue::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
            background: #3B82F6; border-radius: 50%; cursor: pointer;
        }
        .range-thumb-blue::-moz-range-thumb {
            width: 20px; height: 20px; background: #3B82F6; border-radius: 50%;
            cursor: pointer; border: none;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-in-out; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes fade-in-down {
             0% { opacity: 0; transform: translateY(-10px); }
             100% { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down { animation: fade-in-down 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, StrictMode } = React;
        const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, addDoc, collection, serverTimestamp, setLogLevel } = window.firebase;

        // --- SVG Icons ---
        const IconUser = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>);
        const IconDollar = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0c-1.657 0-3-.895-3-2s1.343-2 3-2 3-.895 3-2-1.343-2-3-2m0 8c1.11 0 2.08.402 2.599-1M12 8V7m0 1v8m0 0c-1.11 0-2.08.402-2.599-1M12 16V7m0 0v-1m0 10v1m0 0v1m0-1v-1m0-1c-1.11 0-2.08-.402-2.599-1M12 16v-1m0 1v1m0 0v1m0-1v-1m0-1c1.11 0 2.08.402 2.599-1M12 16v-1" /></svg>);
        const IconCalendar = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>);
        const IconChart = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>);
        const IconCheck = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" /></svg>);
        const IconChevronRight = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" /></svg>);
        const IconAlert = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>);
        const IconInfo = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>);
        const IconEmail = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>);
        const IconPhone = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>);
        const IconUpload = () => (<svg className="w-12 h-12 text-blue-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 48 48"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" /></svg>);
        const IconSpinner = () => (<svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>);
        const IconClose = () => (<svg className="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" /></svg>);
        const IconLightning = () => (<svg className="w-6 h-6 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>);
        const IconTimeline = () => (<svg className="w-6 h-6 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>);
        const IconWarning = () => (<svg className="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" /></svg>);
        const IconLock = () => (<svg className="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clipRule="evenodd" /></svg>);
        const IconShield = () => (<svg className="w-5 h-5 text-blue-500 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>);
        const IconBell = () => (<svg className="w-5 h-5 text-indigo-500 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707l-.707-.707V8a6 6 0 00-6-6zm-4 7.414V8a6 6 0 0112 0v1.414l-1.414 1.414a1 1 0 01-.707.293H6.707a1 1 0 01-.707-.293L5 10.414zM10 18a3 3 0 100-6 3 3 0 000 6z" /></svg>);

        // --- Reusable Form Components (Using new design) ---
        const InputGroup = ({ id, label, type = 'number', value, onChange, placeholder, icon, description, min, max }) => (
            <div className="flex flex-col space-y-2">
                <label htmlFor={id} className="text-sm font-medium text-gray-700 flex items-center">
                    {label}
                    {description && (
                        <div className="relative group ml-2">
                            <span className="text-blue-500 cursor-help"><IconInfo /></span>
                            <span className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-10 pointer-events-none">
                                {description}
                                <div className="absolute left-1/2 -translate-x-1/2 bottom-0 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-t-4 border-t-gray-800 -mb-1"></div>
                            </span>
                        </div>
                    )}
                </label>
                <div className="relative rounded-xl shadow-sm">
                    <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400">
                        {icon}
                    </div>
                    <input type={type} id={id} name={id} value={value} onChange={onChange} placeholder={placeholder} min={min} max={max}
                           className="block w-full pl-12 pr-4 py-3 border border-gray-200 rounded-xl bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" />
                </div>
            </div>
        );

        const SelectGroup = ({ id, label, value, onChange, children, description }) => (
            <div className="flex flex-col space-y-2">
                <label htmlFor={id} className="text-sm font-medium text-gray-700 flex items-center">
                    {label}
                     {description && (
                        <div className="relative group ml-2">
                            <span className="text-blue-500 cursor-help"><IconInfo /></span>
                            <span className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-10 pointer-events-none">
                                {description}
                                <div className="absolute left-1/2 -translate-x-1/2 bottom-0 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-t-4 border-t-gray-800 -mb-1"></div>
                            </span>
                        </div>
                    )}
                </label>
                <select id={id} name={id} value={value} onChange={onChange}
                        className="block w-full pl-4 pr-10 py-3 border border-gray-200 rounded-xl bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition appearance-none">
                    {children}
                </select>
            </div>
        );

        const CheckboxGroup = ({ id, label, checked, onChange, description }) => (
            <label htmlFor={id} className="flex items-center p-4 bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition cursor-pointer has-[:checked]:ring-2 has-[:checked]:ring-blue-500 has-[:checked]:border-blue-500">
                <input id={id} name={id} type="checkbox" checked={checked} onChange={onChange}
                       className="h-5 w-5 text-blue-600 rounded-md border-gray-300 focus:ring-blue-500" />
                <div className="ml-4">
                    <span className="text-base font-semibold text-gray-800">{label}</span>
                    <p className="text-sm text-gray-500">{description}</p>
                </div>
            </label>
        );

        const RadioGroup = ({ name, value, label, description, checked, onChange }) => (
            <label className={`flex p-5 rounded-xl border-2 transition cursor-pointer ${checked ? 'bg-blue-50 border-blue-500 shadow-lg' : 'bg-white border-gray-200 hover:border-gray-300'}`}>
                <input type="radio" name={name} value={value} checked={checked} onChange={onChange}
                       className="mt-1 h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300" />
                <div className="ml-4">
                    <span className="text-lg font-bold text-gray-900">{label}</span>
                    <p className="text-sm text-gray-600 mt-1">{description}</p>
                </div>
            </label>
        );

        // --- Credit Report Upload Component ---
        const CreditReportUpload = ({ onReportAnalyzed }) => {
            const [uploadStatus, setUploadStatus] = useState('idle'); // idle, uploading, analyzing, complete
            const handleFileUpload = async (file) => {
                if (!file) return; setUploadStatus('uploading');
                setTimeout(() => {
                    setUploadStatus('analyzing');
                    setTimeout(() => {
                        const mockAnalysis = { ficoScore: 642, totalDebt: 28750, accountsEnrolling: 6, positiveAccounts: 2, oldestAccountAge: 9, utilization: 85, totalCreditLimit: 35000 };
                        onReportAnalyzed(mockAnalysis); setUploadStatus('complete');
                    }, 2000);
                }, 1000);
            };
            return (
                <div className="bg-blue-50 rounded-xl p-6 border-2 border-blue-200 mb-8">
                    <div className="text-center">
                        <h3 className="text-lg font-semibold text-gray-800 mb-2">üöÄ Want Maximum Accuracy?</h3>
                        <p className="text-gray-600 mb-4">Upload your credit report for precise, personalized projections</p>
                        {uploadStatus === 'idle' && (
                            <div className="border-2 border-dashed border-blue-300 rounded-lg p-8">
                                <input type="file" accept=".pdf,.jpg,.png" onChange={(e) => handleFileUpload(e.target.files[0])} className="hidden" id="credit-report-upload" />
                                <label htmlFor="credit-report-upload" className="cursor-pointer flex flex-col items-center">
                                    <IconUpload />
                                    <span className="text-blue-600 font-semibold">Click to upload your credit report</span>
                                    <span className="text-sm text-gray-500 mt-1">PDF, JPG, or PNG ‚Ä¢ Max 10MB</span>
                                </label>
                            </div>
                        )}
                        {uploadStatus === 'uploading' && (<div className="text-center py-8"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div><p className="text-blue-600 font-semibold">Uploading...</p></div>)}
                        {uploadStatus === 'analyzing' && (<div className="text-center py-8"><div className="animate-pulse text-4xl mb-4">üîç</div><p className="text-blue-600 font-semibold">Analyzing profile...</p><p className="text-sm text-gray-500 mt-2">This may take a moment</p></div>)}
                        {uploadStatus === 'complete' && (<div className="bg-green-100 rounded-lg p-4"><div className="text-green-600 text-2xl mb-2">‚úÖ</div><p className="text-green-700 font-semibold">Analysis Complete!</p><p className="text-sm text-gray-600 mt-1">Your form has been updated.</p></div>)}
                    </div>
                </div>
            );
        };

        // --- Step Components (Using new design and order) ---
        const Step1Scenario = ({ userData, updateUserData }) => (
            <div className="max-w-3xl mx-auto px-4">
                <div className="bg-white rounded-3xl shadow-2xl border border-gray-100 p-8 md:p-12">
                    <h2 className="text-2xl font-bold text-gray-800 mb-2">Step 1: Choose Your Scenario</h2>
                    <p className="text-gray-600 mb-8">Are you just starting or already in the program? This changes the simulation.</p>
                    <div className="space-y-6">
                        <RadioGroup name="scenarioType" label="Pre-Enrollment" description="Simulate your *full* journey from today, including the initial credit score dip." value="pre-enrollment" checked={userData.scenarioType === 'pre-enrollment'} onChange={(e) => updateUserData({ scenarioType: e.target.value })} />
                        <RadioGroup name="scenarioType" label="Progress Tracker" description="You're already enrolled. Simulate your *remaining* journey from your current score." value="progress-tracker" checked={userData.scenarioType === 'progress-tracker'} onChange={(e) => updateUserData({ scenarioType: e.target.value })} />
                    </div>
                    {userData.scenarioType === 'progress-tracker' && (
                        <div className="mt-8 pt-8 border-t border-gray-200 space-y-6">
                            <h3 className="text-xl font-semibold text-gray-700">Your Program Progress</h3>
                            <InputGroup id="monthsInProgram" label="Months in Program" value={userData.monthsInProgram} onChange={(e) => updateUserData({ monthsInProgram: e.target.value })} placeholder="e.g., 6" icon={<IconCalendar />} description="How many months have you been in the program?" min="0" />
                            <InputGroup id="settledAccounts" label="Settled Accounts" value={userData.settledAccounts} onChange={(e) => updateUserData({ settledAccounts: e.target.value })} placeholder="e.g., 2" icon={<IconCheck />} description="How many enrolled accounts have been successfully settled?" min="0" />
                            <SelectGroup id="programPhase" label="Current Program Phase" value={userData.programPhase} onChange={(e) => updateUserData({ programPhase: e.target.value })} description="What is the current status of your program?">
                                <option value="accumulation">Accumulation (Building savings)</option><option value="negotiation">Negotiation (Actively settling)</option><option value="settled">Settled (All debts resolved)</option>
                            </SelectGroup>
                        </div>
                    )}
                </div>
            </div>
        );

        const Step2Profile = ({ userData, updateUserData }) => {
            const [durationAdvice, setDurationAdvice] = useState('Shorter timelines require higher monthly payments, offering a faster comeback.');
            const handleDurationChange = (e) => {
                const duration = e.target.value; let advice = 'Shorter timelines...';
                if (duration === '48') advice = 'Our most popular choice...'; else if (duration === '60') advice = 'A comfortable pace...'; else if (duration === '72') advice = 'The extended plan...';
                setDurationAdvice(advice); updateUserData({ programTimeline: parseInt(duration) });
            };
            const handleReportAnalyzed = useCallback((analysis) => {
                let utilValue = 75; // Default mapping from analysis percentage
                if (analysis.utilization <= 10) utilValue = 10; else if (analysis.utilization <= 30) utilValue = 30; else if (analysis.utilization <= 50) utilValue = 50; else if (analysis.utilization <= 75) utilValue = 75; else utilValue = 100;
                updateUserData({ ficoScore: analysis.ficoScore, totalDebt: analysis.totalDebt, accountsEnrolling: analysis.accountsEnrolling, positiveAccounts: analysis.positiveAccounts, oldestAccountAge: analysis.oldestAccountAge, totalCreditLimit: analysis.totalCreditLimit, utilization: utilValue });
            }, [updateUserData]);

            return (
                <div className="max-w-5xl mx-auto px-4">
                    <div className="bg-white rounded-3xl shadow-2xl border border-gray-100 overflow-hidden">
                        {/* Hero Section */}
                        <div className="bg-gradient-to-br from-blue-600 via-indigo-700 to-purple-800 text-white p-10 relative overflow-hidden">
                            <div className="absolute inset-0 bg-gradient-to-br from-blue-500/20 via-transparent to-purple-500/20"></div>
                            <div className="relative z-10 flex items-center justify-between">
                                <div className="text-center sm:text-left">
                                    <h1 className="text-4xl md:text-5xl font-black mb-4 leading-tight">Your Personal <span className="bg-gradient-to-r from-yellow-300 to-orange-400 bg-clip-text text-transparent">Credit Comeback</span> Journey</h1>
                                    <p className="text-blue-100 text-xl font-medium">Every financial transformation starts with understanding your unique profile</p>
                                    <div className="mt-4 flex items-center justify-center sm:justify-start text-blue-200"><div className="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></div><span className="text-sm font-medium">Powered by AI-Enhanced Credit Algorithms</span></div>
                                </div>
                                <div className="hidden md:block"><div className="bg-white bg-opacity-15 backdrop-blur-sm rounded-2xl p-6 border border-white/20"><div className="w-16 h-16 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center"><svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z"/></svg></div></div></div>
                            </div>
                        </div>
                        {/* Form Section */}
                        <div className="p-8 md:p-12">
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">Step 2: Your Financial Snapshot</h2>
                            <p className="text-gray-600 mb-8">Provide your current details or upload a credit report for maximum accuracy.</p>
                            <CreditReportUpload onReportAnalyzed={handleReportAnalyzed} />
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                <InputGroup id="ficoScore" label="Current FICO Score" value={userData.ficoScore} onChange={(e) => updateUserData({ ficoScore: e.target.value })} placeholder="e.g., 650" icon={<IconChart />} description="Enter your most recent FICO Score (300-850)." min="300" max="850" />
                                <InputGroup id="monthlyIncome" label="Total Monthly Income" value={userData.monthlyIncome} onChange={(e) => updateUserData({ monthlyIncome: e.target.value })} placeholder="e.g., 5000" icon={<IconDollar />} description="Your total net (after-tax) monthly income." min="0" />
                                <InputGroup id="totalDebt" label="Total Debt for Resolution" value={userData.totalDebt} onChange={(e) => updateUserData({ totalDebt: e.target.value })} placeholder="e.g., 25000" icon={<IconDollar />} description="Total unsecured debt (credit cards, loans) to enroll." min="0" />
                                <InputGroup id="accountsEnrolling" label="Number of Debt Accounts" value={userData.accountsEnrolling} onChange={(e) => updateUserData({ accountsEnrolling: e.target.value })} placeholder="e.g., 4" icon={<IconUser />} description="How many separate accounts are enrolling?" min="1" />
                                <InputGroup id="positiveAccounts" label="Positive Accounts (Not Enrolling)" value={userData.positiveAccounts} onChange={(e) => updateUserData({ positiveAccounts: e.target.value })} placeholder="e.g., 1" icon={<IconCheck />} description="Accounts staying open and paid on time (auto, mortgage)." min="0" />
                                <InputGroup id="oldestAccountAge" label="Oldest Account Age (Years)" value={userData.oldestAccountAge} onChange={(e) => updateUserData({ oldestAccountAge: e.target.value })} placeholder="e.g., 7" icon={<IconCalendar />} description="Age of your oldest active credit account." min="0" />
                                <InputGroup id="totalCreditLimit" label="Total Credit Limit (All Accounts)" value={userData.totalCreditLimit} onChange={(e) => updateUserData({ totalCreditLimit: e.target.value })} placeholder="e.g., 30000" icon={<IconDollar />} description="Sum of all credit limits (enrolling & non-enrolling)." min="0" />
                                <SelectGroup id="utilization" label="Credit Utilization (Enrolled)" value={userData.utilization} onChange={(e) => updateUserData({ utilization: parseInt(e.target.value) })} description="Avg balance/limit ratio ONLY for enrolled accounts.">
                                    <option value={10}>0% - 10% (Excellent)</option><option value={30}>10% - 30% (Good)</option><option value={50}>30% - 50% (Fair)</option><option value={75}>50% - 75% (Poor)</option><option value={100}>75% - 100% (Very Poor)</option>
                                </SelectGroup>
                                <div className="md:col-span-2"><SelectGroup id="programTimeline" label="Expected Program Timeline" value={userData.programTimeline} onChange={handleDurationChange} description="Select the program duration.">
                                    <option value={24}>24 Months</option><option value={36}>36 Months</option><option value={48}>48 Months</option><option value={60}>60 Months</option><option value={72}>72 Months</option>
                                </SelectGroup></div>
                                <div className="md:col-span-2 mt-2"><div className="p-4 bg-blue-50 border border-blue-200 rounded-xl flex items-start space-x-3"><span className="text-blue-500 flex-shrink-0"><IconInfo /></span><p className="text-sm text-blue-700">{durationAdvice}</p></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Step3Tools = ({ userData, updateUserData }) => (
            <div className="max-w-3xl mx-auto px-4">
                <div className="bg-white rounded-3xl shadow-2xl border border-gray-100 p-8 md:p-12">
                    <h2 className="text-2xl font-bold text-gray-800 mb-2">Step 3: Supercharge Your Recovery</h2>
                    <p className="text-gray-600 mb-8">Select credit-building tools to use alongside your program.</p>
                    <div className="space-y-5 mb-10">
                        <CheckboxGroup id="securedCard" label="Secured Credit Card" description="Establishes new positive payment history (open 6-9 mo in)." checked={userData.securedCard} onChange={(e) => updateUserData({ securedCard: e.target.checked })} />
                        <CheckboxGroup id="creditBuilder" label="Credit Builder Loan" description="Adds an 'installment' account, improving 'Credit Mix'." checked={userData.creditBuilder} onChange={(e) => updateUserData({ creditBuilder: e.target.checked })} />
                        <CheckboxGroup id="authorizedUser" label="Authorized User" description="'Piggyback' on a trusted person's good credit history." checked={userData.authorizedUser} onChange={(e) => updateUserData({ authorizedUser: e.target.checked })} />
                    </div>
                    <div className="pt-8 border-t border-gray-200">
                        <h3 className="text-xl font-bold text-gray-800 mb-2">Save Your Results</h3>
                        <p className="text-gray-600 mb-6">Enter details to save this simulation and discuss it.</p>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                            <InputGroup id="firstName" label="First Name" type="text" value={userData.firstName} onChange={(e) => updateUserData({ firstName: e.target.value })} placeholder="e.g., Jane" icon={<IconUser />} />
                            <InputGroup id="phone" label="Phone Number" type="tel" value={userData.phone} onChange={(e) => updateUserData({ phone: e.target.value })} placeholder="(555) 123-4567" icon={<IconPhone />} />
                            <div className="md:col-span-2"><InputGroup id="emailCapture" label="Email Address" type="email" value={userData.email} onChange={(e) => updateUserData({ email: e.target.value })} placeholder="jane.doe@example.com" icon={<IconEmail />} /></div>
                        </div>
                    </div>
                </div>
            </div>
        );

        const LoadingSpinner = () => (<div className="flex flex-col items-center justify-center p-20 text-center"><div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div><h3 className="text-2xl font-bold text-gray-800 mt-8">Calculating...</h3><p className="text-gray-600 mt-2">Running your custom data through our AI model.</p></div>);

        // --- Results Page Components ---
        const AcceleratorMotivation = ({ results, userData, setCurrentStep }) => {
            const accelerators = [ { id: 'securedCard', title: 'Secured Credit Card', points: 30, color: 'blue' }, { id: 'creditBuilder', title: 'Credit Builder Loan', points: 25, color: 'green' }, { id: 'authorizedUser', title: 'Authorized User', points: 10, color: 'purple' }, ];
            const unselected = accelerators.filter(a => !userData[a.id]);
            if (unselected.length === 0) return (<div className="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4 text-center mt-8"><p className="font-semibold text-yellow-800">Already optimized!</p></div>);
            const colorClasses = { blue: { border: 'border-blue-200', bg: 'bg-blue-100', text: 'text-blue-600' }, green: { border: 'border-green-200', bg: 'bg-green-100', text: 'text-green-600' }, purple: { border: 'border-purple-200', bg: 'bg-purple-100', text: 'text-purple-600' }, };
            return (
                <div className="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl p-6 border-2 border-purple-200 shadow-lg mt-8">
                    <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center"><IconLightning /> Accelerate Your Comeback</h3>
                    <p className="text-gray-600 mb-4">See potential gains by adding these unselected tools:</p>
                    <div className="space-y-3">
                        {unselected.map(a => { const colors = colorClasses[a.color] || colorClasses.blue; return (
                            <div key={a.id} className={`flex items-center justify-between p-3 rounded-lg bg-white shadow-sm border ${colors.border}`}>
                                <div className="flex items-center"><span className={`w-6 h-6 rounded-full ${colors.bg} ${colors.text} flex items-center justify-center mr-3`}>{a.id === 'securedCard' ? 'üí≥' : a.id === 'creditBuilder' ? 'üè¶' : 'üë•'}</span><span className="font-semibold text-gray-700">{a.title}</span></div>
                                <span className={`text-lg font-extrabold ${colors.text}`}>+{a.points} pts</span>
                            </div>
                        );})}
                    </div>
                    <button onClick={() => setCurrentStep(3)} className="w-full mt-5 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg transition-colors">Review Accelerators & Re-Calculate</button>
                </div>
            );
        };

        const RecoveryTimeline = ({ results, userData }) => {
            const { milestoneDipScore: dipScore, milestoneStabilizationScore: stabScore, milestoneRecoveryScore: recScore, projectedScore: finalScore, initialScore } = results;
            const timelineNum = Number(userData.programTimeline) || 36;
            const dipChange = initialScore - dipScore;
            const milestones = []; const startMonth = 12; const endMonth = 24; const stabMonth = 12; const gainPerMonth = (endMonth > startMonth) ? (recScore - stabScore) / (endMonth - startMonth) : 0;
            for (let m = startMonth; m <= endMonth; m += 3) { const monthsAfterStab = m - stabMonth; const score = Math.round(stabScore + (gainPerMonth * monthsAfterStab)); milestones.push({ month: m, score, title: `Month ${m}`, color: 'yellow', description: `Score progress.` }); }
            const timelineEvents = [ { month: 0, score: initialScore, title: "Start", color: "blue", description: "Beginning transformation." }, ...(userData.scenarioType === 'pre-enrollment' ? [{ month: "6-9", score: dipScore, title: "Strategic Dip", color: "red", description: `Temporary drop (~-${dipChange} pts).` }] : []), ...milestones, { month: timelineNum, score: finalScore, title: "Graduation", color: "green", description: `Debt freedom!` } ].filter(e => (typeof e.month === 'string' ? 9 : e.month) <= timelineNum || e.month === 0 || e.month === "6-9");
            const finalEvents = timelineEvents.reduce((acc, cur) => { const x = acc.find(item => item.month === cur.month); if (!x) return acc.concat([cur]); else if (cur.color === 'green') { acc.pop(); return acc.concat([cur]); } else return acc; }, []);
            const textClasses = { blue: 'text-blue-700', red: 'text-red-700', green: 'text-green-700', yellow: 'text-yellow-700' }; const bgClasses = { blue: 'bg-blue-600', red: 'bg-red-500', green: 'bg-green-600', yellow: 'bg-yellow-500' }; const borderClasses = { blue: 'border-blue-600', red: 'border-red-500', green: 'border-green-600', yellow: 'border-yellow-500' }; const cardBgClasses = { blue: 'bg-white', red: 'bg-red-50', green: 'bg-green-50', yellow: 'bg-white' };
            return (
                <div className="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-xl p-6 md:p-8 border border-blue-200">
                    <h3 className="text-2xl font-bold text-gray-800 mb-6 flex items-center"><IconTimeline /> Your Recovery Journey</h3>
                    <div className="relative pl-12"><div className="absolute left-10 top-0 bottom-0 w-1 bg-gradient-to-b from-red-400 via-yellow-400 to-green-400 rounded-full"></div><div className="space-y-8">
                        {finalEvents.map((e, i) => { let txtCol = textClasses[e.color] || textClasses.blue; let bgCol = bgClasses[e.color] || bgClasses.blue; let borderCol = borderClasses[e.color] || borderClasses.blue; let cardBg = cardBgClasses[e.color] || cardBgClasses.blue; return (
                            <div key={i} className="flex items-start relative"><div className={`w-6 h-6 ${bgCol} rounded-full flex-shrink-0 absolute left-7 top-1/2 transform -translate-x-1/2 -translate-y-1/2 shadow-lg z-10`}></div><div className="ml-8 flex-1 pl-4"><div className={`rounded-xl p-4 shadow-md border-l-4 ${borderCol} ${cardBg}`}><div className="flex justify-between items-start"><div><h4 className={`font-bold ${txtCol}`}>{e.title}</h4><p className="text-gray-600 text-sm mt-1">{e.description}</p></div><div className="text-right flex-shrink-0 ml-4"><div className={`text-xl font-bold ${txtCol}`}>{e.score}</div><div className="text-xs text-gray-500">FICO</div></div></div></div></div></div>
                        );})}
                    </div></div>
                </div>
            );
        };

        const Step4Results = ({ results, isLoading, userData, onReset, setCurrentStep }) => {
            if (isLoading) return (<div className="max-w-3xl mx-auto px-4"><div className="bg-white rounded-3xl shadow-2xl border border-gray-100 p-8 md:p-12"><LoadingSpinner /></div></div>);
            if (!results) return (<div className="max-w-3xl mx-auto px-4 text-center"><div className="bg-white rounded-3xl shadow-2xl border border-gray-100 p-8 md:p-12"><h2 className="text-2xl font-bold text-red-600 mb-4">Calculation Failed</h2><p className="text-gray-600 mb-6">Check inputs or try again.</p><button onClick={onReset} className="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition transform hover:-translate-y-0.5">Start Over</button></div></div>);
            const { scoreGain, recoveryTime, postDTI, savings, impactPenalty } = results; const companyBranding = "CreDebtFree.com";
            const getConfidenceMessage = () => { if (results.impactPenalty > 0) return { heading: `Temporary dip is part of the plan.`, text: `Initial drop of **${results.impactPenalty} points** (3-6 mo) enables **$${results.savings.toLocaleString()}** savings. Strategic settlement leads to full rebound.` }; return { heading: `Your comeback starts now.`, text: `Steady increase toward **+${results.scoreGain} point** target. **$${results.savings.toLocaleString()}** savings fuel recovery.` }; };
            const confidence = getConfidenceMessage(); const FactorBadge = ({ factor, pre, post, color }) => { const textClass = `text-${color}-600`; const bgClass = `bg-${color}-100`; return (<div className="flex items-center justify-between py-2 border-b border-gray-100"><span className="font-medium text-gray-700 text-sm">{factor}</span><div className="flex items-center space-x-2"><span className="text-xs text-gray-500 line-through">Pre: {pre}</span><span className={`text-xs font-bold ${textClass} ${bgClass} px-2 py-0.5 rounded-full`}>Post: {post}</span></div></div>); };
            const numUtil = Number(userData.utilization); const numPos = Number(userData.positiveAccounts); const numAge = Number(userData.oldestAccountAge);
            const utilPre = numUtil > 75 ? "75%+" : numUtil > 50 ? "51-75%" : numUtil > 30 ? "31-50%" : "<30%"; const utilPost = "Optimal (<10%)"; const payPre = numUtil > 50 ? "Damaged" : "Fair"; const payPost = "Building (100%)"; const mixPre = numPos === 0 ? "Limited" : "Static"; const mixPost = "Diversified"; const agePre = numAge < 5 ? "<5 Yrs" : "5+ Yrs"; const agePost = "Aging Gracefully"; const newPre = numAge < 5 ? "Fragile" : "Low Impact"; const newPost = "Strategic";

            return (
                <div className="max-w-6xl mx-auto px-4">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl p-8 mb-8 text-white shadow-xl">
                        <div className="flex flex-col sm:flex-row items-center justify-between">
                            <div className="text-center sm:text-left mb-4 sm:mb-0">
                                <h2 className="text-2xl font-bold mb-2">Your Projection</h2>
                                <div className="flex items-center justify-center sm:justify-start space-x-4 text-sm text-blue-100"><span className="flex items-center"><IconCheck /> {companyBranding}</span><span className="flex items-center"><IconChart /> Dynamic Model</span></div>
                            </div>
                            <div className="text-center sm:text-right"><div className="text-3xl font-bold">{results.initialScore} ‚Üí {results.projectedScore}</div><div className="text-blue-100">FICO Journey</div></div>
                        </div>
                    </div>
                    {/* Key Projections */}
                    <div className="p-8 bg-white rounded-2xl shadow-xl border border-gray-100">
                        <h3 className="text-xl font-bold text-gray-900 mb-6 border-b pb-3">Key Projections</h3>
                        <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-6 border border-green-200"><h3 className="text-sm font-semibold text-gray-600">Score Gain</h3><div className="text-3xl font-bold text-green-600 mt-1">+{results.scoreGain} pts</div></div>
                            <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200"><h3 className="text-sm font-semibold text-gray-600">Recovery Time</h3><div className="text-3xl font-bold text-blue-600 mt-1">{results.recoveryTime}</div></div>
                            <div className="bg-gradient-to-br from-purple-50 to-violet-50 rounded-xl p-6 border border-purple-200"><h3 className="text-sm font-semibold text-gray-600">Post-DTI</h3><div className="text-3xl font-bold text-purple-600 mt-1">{results.postDTI}%</div></div>
                            <div className="bg-gradient-to-br from-orange-50 to-amber-50 rounded-xl p-6 border border-orange-200"><h3 className="text-sm font-semibold text-gray-600">Savings</h3><div className="text-3xl font-bold text-orange-600 mt-1">${results.savings.toLocaleString()}</div></div>
                        </div>
                        {/* Confidence */}
                        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                            <div className="flex"><div className="flex-shrink-0"><IconWarning /></div><div className="ml-3"><h3 className="text-sm font-medium text-yellow-800" dangerouslySetInnerHTML={{ __html: confidence.heading.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') }} /><div className="mt-2 text-sm text-yellow-700"><p dangerouslySetInnerHTML={{ __html: confidence.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') }} /></div></div></div>
                        </div>
                        {/* Action Buttons */}
                        <div className="flex flex-col sm:flex-row gap-4 justify-center mt-6">
                            <button onClick={onReset} className="w-full sm:w-auto border-2 border-gray-300 text-gray-700 px-8 py-3 rounded-lg font-semibold hover:border-gray-400 hover:bg-gray-50 transition">Run New Simulation</button>
                            {(userData.email || userData.phone) ? (<button className="w-full sm:w-auto bg-gradient-to-r from-green-600 to-emerald-600 text-white px-8 py-3 rounded-lg font-semibold hover:from-green-700 hover:to-emerald-700 transition shadow-lg">Send My Report</button>) : (<button onClick={() => setCurrentStep(3)} className="w-full sm:w-auto bg-gradient-to-r from-blue-600 to-indigo-700 text-white font-black rounded-xl shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5 px-8 py-3">Save & Get Full Report</button>)}
                        </div>
                    </div>
                    {/* Timeline & Factors */}
                    <div className="grid lg:grid-cols-3 gap-6 mt-8">
                        <div className="lg:col-span-2"><RecoveryTimeline results={results} userData={userData} /></div>
                        <div className="lg:col-span-1 bg-white rounded-2xl shadow-xl p-6 border border-gray-100 h-full">
                            <h3 className="text-xl font-bold text-gray-900 mb-4">Weight Model Analysis</h3>
                            <div className="space-y-1">
                                <FactorBadge factor={`Utiliz. (${Math.round((results.weights.utilization || 0) * 100)}%)`} pre={utilPre} post={utilPost} color="green" />
                                <FactorBadge factor={`History (${Math.round((results.weights.paymentHistory || 0) * 100)}%)`} pre={payPre} post={payPost} color="blue" />
                                <FactorBadge factor={`Acct. Age (${Math.round((results.weights.accountAge || 0) * 100)}%)`} pre={agePre} post={agePost} color="purple" />
                                <FactorBadge factor={`Mix (${Math.round((results.weights.creditMix || 0) * 100)}%)`} pre={mixPre} post={mixPost} color="yellow" />
                                <FactorBadge factor={`New Credit (${Math.round((results.weights.newCredit || 0) * 100)}%)`} pre={newPre} post={newPost} color="indigo" />
                                <p className="text-xs text-gray-500 mt-4" dangerouslySetInnerHTML={{ __html: "Weighting adjusts based on **initial score** & **DTI**, maximizing impact of debt clearing.".replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') }} />
                            </div>
                        </div>
                    </div>
                    {/* Accelerator */}
                    <AcceleratorMotivation results={results} userData={userData} setCurrentStep={setCurrentStep} />
                </div>
            );
        };

        const TrustIndicators = () => (
            <div className="bg-gray-50 border-t border-gray-200 py-8">
                <div className="max-w-4xl mx-auto px-4"><div className="flex flex-wrap items-center justify-center space-x-8 text-sm text-gray-600">
                    <div className="flex items-center mb-2 sm:mb-0"><IconLock /> SSL Secured</div>
                    <div className="flex items-center mb-2 sm:mb-0"><IconShield /> Data Encrypted</div>
                    <div className="flex items-center"><IconBell /> Private & Confidential</div>
                </div></div>
            </div>
        );

        // --- Main App Component ---
        const App = () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = useMemo(() => { try { return typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {}; } catch (e) { console.error("Bad Firebase config:", e); return {}; } }, []);
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            const companyBranding = "CreDebtFree.com";
            const [db, setDb] = useState(null); const [auth, setAuth] = useState(null); const [userId, setUserId] = useState(null); const [isAuthReady, setIsAuthReady] = useState(false);
            const defaultUserData = useMemo(() => ({ ficoScore: '', totalDebt: '', monthlyIncome: '', utilization: 75, accountsEnrolling: '', positiveAccounts: '', oldestAccountAge: '', totalCreditLimit: '', programTimeline: 36, securedCard: true, creditBuilder: false, authorizedUser: false, scenarioType: 'pre-enrollment', monthsInProgram: '', settledAccounts: '', programPhase: 'accumulation', email: '', firstName: '', phone: '' }), []);
            const [currentStep, setCurrentStep] = useState(1); const [userData, setUserData] = useState(defaultUserData); const [results, setResults] = useState(null); const [error, setError] = useState(null); const [isLoading, setIsLoading] = useState(false);
            const showError = useCallback((message) => { setError(message); setTimeout(() => setError(null), 5000); }, []);
            const updateUserData = useCallback((data) => { setUserData(prev => ({ ...prev, ...data })); }, []);

            useEffect(() => {
                if (!firebaseConfig || typeof firebaseConfig !== 'object' || Object.keys(firebaseConfig).length === 0) { console.error("Firebase config invalid."); setIsAuthReady(true); setUserId(crypto.randomUUID()); return; }
                let app;
                try {
                     app = initializeApp(firebaseConfig);
                    const authInstance = getAuth(app); const dbInstance = getFirestore(app);
                    if (typeof setLogLevel === 'function') setLogLevel('debug');
                    setAuth(authInstance); setDb(dbInstance);
                    const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                        let currentUserId;
                        if (!user) {
                            try {
                                if (initialAuthToken) { const cred = await signInWithCustomToken(authInstance, initialAuthToken); currentUserId = cred.user.uid; }
                                else { const cred = await signInAnonymously(authInstance); currentUserId = cred.user.uid; }
                            } catch (e) { console.error("FB Sign-in Error:", e); currentUserId = crypto.randomUUID(); showError("Auth failed."); }
                        } else { currentUserId = user.uid; }
                        setUserId(currentUserId); setIsAuthReady(true);
                    });
                    return () => unsubscribe();
                } catch (e) { console.error("FB Init Error:", e); setIsAuthReady(true); setUserId(crypto.randomUUID()); showError("Core service init failed."); }
            }, [initialAuthToken, firebaseConfig, showError]);

            // Corrected: Removed invalid 'k' notation for numbers
            const calculateWeights = useCallback((fico, debt, income, posAccts, age, limit) => { const baseW = { pH: 0.35, util: 0.30, age: 0.15, mix: 0.10, newC: 0.10 }; const s=Number(fico)||500, d=Number(debt)||10000, i=Number(income)||3000, pA=Number(posAccts)||0, a=Number(age)||2, l=Number(limit)||(d*1.5); const tOU=l>0?d/l:1; if(s>=740){baseW.pH=0.25;baseW.util=0.40;baseW.age=0.20}else if(s<=580){baseW.pH=0.45;baseW.util=0.25;baseW.newC=0.15}const dti=i>0?d/(i*12):1; if(dti>0.45){baseW.util=Math.min(0.5,baseW.util+0.05);baseW.pH=Math.max(0.1,baseW.pH-0.05)}if(tOU<0.30){baseW.age=Math.min(0.25,baseW.age+0.05);baseW.pH=Math.max(0.30,baseW.pH-0.05)}if(pA>0){baseW.pH=Math.max(0.30,baseW.pH-0.05);baseW.mix=Math.min(0.20,baseW.mix+0.05)}if(a<4){baseW.age=Math.max(0.05,baseW.age-0.05);baseW.newC=Math.min(0.20,baseW.newC+0.05)}else if(a>10){baseW.age=Math.min(0.25,baseW.age+0.05)}const sum=Object.values(baseW).reduce((x,y)=>x+y,0);if(sum===0)return baseW;for(const k in baseW){baseW[k]/=sum} return {paymentHistory:baseW.pH,utilization:baseW.util,accountAge:baseW.age,creditMix:baseW.mix,newCredit:baseW.newC}; }, []);
            const calculateWorstCaseImpact = useCallback((data, weights) => { const s=Number(data.ficoScore)||500, u=Number(data.utilization)||75, pA=Number(data.positiveAccounts)||0, a=Number(data.oldestAccountAge)||2; let drop=0; const uF=Math.max(0,(u-30)/10); drop+=uF*10*(weights.utilization*3); const sF=Math.max(0,(700-s)/10); drop+=sF*5; drop-=pA*5; if(a>10)drop-=10; return Math.min(150,Math.max(20,Math.round(drop))); }, []);
            const runSimulation = useCallback((data) => { const iS=Number(data.ficoScore), tD=Number(data.totalDebt), mI=Number(data.monthlyIncome), pA=Number(data.positiveAccounts), oAA=Number(data.oldestAccountAge), tCL=Number(data.totalCreditLimit), pT=Number(data.programTimeline)||36, mIP=Number(data.monthsInProgram)||0; if(isNaN(iS)||isNaN(tD)||isNaN(mI)||isNaN(pA)||isNaN(oAA)||isNaN(tCL))throw new Error("Invalid input"); const w=calculateWeights(iS,tD,mI,pA,oAA,tCL); let lPS,pS; let rM=pT; let iP=0; if(data.scenarioType==='pre-enrollment'){iP=calculateWorstCaseImpact(data,w);lPS=Math.max(300,iS-iP)}else{lPS=iS;rM=Math.max(12,pT-mIP);iP=0} let tPG=0; tPG+=w.utilization*200; tPG+=w.paymentHistory*150*(rM/(pT||1)); tPG+=w.accountAge*100; let tG=0; if(data.securedCard)tG+=30; if(data.creditBuilder)tG+=25; if(data.authorizedUser)tG+=10; tPG+=tG; pS=Math.min(850,lPS+Math.round(tPG)); const pD=tD*0.4; const aPD=pD*0.05/12; const dtiR=mI>0?(aPD/mI)*100:100; const dS=tD*0.6; const tGain=pS-lPS; const sS=lPS+Math.round(tGain*0.1); const rS=lPS+Math.round(tGain*0.65); return {initialScore:iS,lowPointScore:lPS,projectedScore:pS,scoreGain:pS-iS,recoveryTime:`${pT} months`,postDTI:Math.min(50,dtiR).toFixed(1),savings:dS,impactPenalty:iP,recoveryMonths:rM,weights:w,milestoneDipScore:lPS,milestoneStabilizationScore:sS,milestoneRecoveryScore:rS}; }, [calculateWeights, calculateWorstCaseImpact]);
            const saveSimulation = useCallback(async(d,r)=>{if(!db||!userId||!isAuthReady){console.warn("DB/User/Auth not ready.");showError("Cannot save: Connection not ready.");return;}const path=`artifacts/${appId}/users/${userId}/simulations`;const ref=collection(db,path);try{const docRef=await addDoc(ref,{userId,timestamp:serverTimestamp(),input:d,results:r});console.log("Saved! ID:",docRef.id);showError("Results Saved!")}catch(e){console.error("Save Error:",e);showError(`Save failed: ${e.message}`)}},[db,userId,appId,isAuthReady,showError]);

            const calculateAndShowResults = useCallback(()=>{setIsLoading(true);setResults(null);setTimeout(()=>{try{const calcRes=runSimulation(userData);setResults(calcRes);saveSimulation(userData,calcRes);setIsLoading(false);setCurrentStep(4)}catch(simErr){console.error("Sim Error:",simErr);showError(`Sim Error: ${simErr.message}`);setIsLoading(false)}},1500)},[userData,runSimulation,saveSimulation,showError,setIsLoading,setResults,setCurrentStep]);
            const handlePrevious = useCallback(()=>{if(currentStep>1){setCurrentStep(c=>c-1);setResults(null)}},[currentStep,setCurrentStep,setResults]);
            const handleReset = useCallback(()=>{setCurrentStep(1);setResults(null);setUserData(defaultUserData)},[defaultUserData,setCurrentStep,setResults,setUserData]);
            const handleNext = useCallback(()=>{if(currentStep===1){if(!userData.scenarioType){showError("Select scenario.");return;}if(userData.scenarioType==='progress-tracker'){const nM=Number(userData.monthsInProgram),nS=Number(userData.settledAccounts);if(isNaN(nM)||nM<0){showError("Invalid months.");return;}if(isNaN(nS)||nS<0){showError("Invalid settled accounts.");return;}}}else if(currentStep===2){const{ficoScore:f,totalDebt:d,accountsEnrolling:aE,positiveAccounts:pA,oldestAccountAge:oAA,monthlyIncome:mI,utilization:u,programTimeline:pT,totalCreditLimit:tCL}=userData;const nF=Number(f),nI=Number(mI),nD=Number(d),nL=Number(tCL),nA=Number(aE),nP=Number(pA),nAge=Number(oAA),nPT=Number(pT);if(isNaN(nF)||nF<300||nF>850){showError("Invalid FICO.");return;}if(isNaN(nI)||nI<=0){showError("Invalid Income.");return;}if(isNaN(nD)||nD<=0){showError("Invalid Debt.");return;}if(isNaN(nL)||nL<0){showError("Invalid Limit.");return;}if(nL>0&&nL<nD){showError("Limit < Debt.");return;}if(isNaN(nA)||nA<1){showError("Invalid Accounts.");return;}if(isNaN(nP)||nP<0){showError("Invalid Positive Accts.");return;}if(isNaN(nAge)||nAge<0){showError("Invalid Age.");return;}if(!u){showError("Select Utilization.");return;}if(isNaN(nPT)||![24,36,48,60,72].includes(nPT)){showError("Invalid Timeline.");return;}}if(currentStep===3){calculateAndShowResults();return;}if(currentStep<4){setCurrentStep(c=>c+1);window.scrollTo(0,0)}},[currentStep,userData,showError,calculateAndShowResults,setCurrentStep]);

            const renderStep = () => { if (!isAuthReady && !userId) return (<div className="max-w-4xl mx-auto px-4"><div className="bg-white rounded-2xl shadow-2xl p-8 text-center border border-gray-100"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div><p className="text-gray-700 font-semibold">Initializing...</p><p className="text-sm text-gray-500 mt-2">Securing session...</p></div></div>); switch (currentStep) { case 1: return <Step1Scenario userData={userData} updateUserData={updateUserData} />; case 2: return <Step2Profile userData={userData} updateUserData={updateUserData} />; case 3: return <Step3Tools userData={userData} updateUserData={updateUserData} />; case 4: return <Step4Results results={results} isLoading={isLoading} userData={userData} onReset={handleReset} setCurrentStep={setCurrentStep} />; default: return <Step1Scenario userData={userData} updateUserData={updateUserData} />; } };
            const steps = useMemo(() => ['Scenario', 'Profile', 'Tools', 'Results'], []); const progressWidth = Math.min(100, Math.max(0, currentStep === 4 ? 100 : ((currentStep - 1) / (steps.length - 1)) * 100));

            return (
                <div className="min-h-screen bg-gray-50 font-sans">
                    <div className="bg-white shadow-md border-b border-gray-100 sticky top-0 z-30">
                        <div className="max-w-6xl mx-auto px-4 py-4 md:py-6"><h1 className="text-2xl md:text-4xl font-bold text-center text-gray-900 mb-1">Credit Comeback Simulator</h1><p className="text-base md:text-lg text-gray-600 text-center">Personalized recovery with AI accuracy</p>{userId && (<p className="text-sm text-gray-400 text-center mt-2">ID: <span className="font-mono text-xs bg-gray-100 px-2 py-1 rounded-md">{userId}</span></p>)}</div>
                    </div>
                    <div className="p-4 md:p-10">
                        {error && (<div className="fixed top-24 right-5 z-50 max-w-sm w-full animate-fade-in-down"><div className="bg-red-600 text-white p-4 rounded-xl shadow-2xl flex items-start space-x-3"><span className="flex-shrink-0 pt-0.5"><IconAlert /></span><div className="flex-1"><h4 className="font-bold">Error</h4><p className="text-sm">{error}</p></div><button onClick={() => setError(null)} className="ml-auto -mr-1 -mt-1 p-1 rounded-full text-red-100 hover:text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-white"><IconClose /></button></div></div>)}
                        {currentStep < 4 && (
                            <div className="max-w-3xl mx-auto mb-8 bg-white shadow-lg p-4 rounded-xl border border-gray-100">
                                <h2 className="sr-only">Progress</h2><div className="relative pt-6"><div className="overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-200"><div style={{ width: `${progressWidth}%` }} className="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-green-500 transition-all duration-500"></div></div><div className="flex justify-between -mt-10">{steps.map((step, index) => (<div key={step} className="w-1/4 flex flex-col items-center text-center"><div className={`w-8 h-8 rounded-full flex items-center justify-center transition-all duration-300 mb-1 ${index + 1 <= currentStep ? 'bg-green-500 text-white' : 'bg-white text-gray-500 border-2 border-gray-300'}`}>{index + 1 < currentStep ? <IconCheck /> : <span className="text-sm font-bold">{index + 1}</span>}</div><span className={`text-xs font-semibold ${index + 1 <= currentStep ? 'text-gray-800' : 'text-gray-400'}`}>{step}</span></div>))}</div></div>
                            </div>
                        )}
                        <main className="mt-6">{renderStep()}</main>
                        {currentStep < 4 && isAuthReady && (
                            <footer className="max-w-5xl mx-auto px-4 mt-10 mb-6">
                                <div className="flex justify-between items-center">
                                    <button onClick={handlePrevious} disabled={currentStep === 1} className={`px-6 py-3 text-sm font-bold rounded-lg shadow-md border transition duration-150 ease-in-out ${ currentStep === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed border-gray-200' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500' }`}>Back</button>
                                    <button onClick={handleNext} disabled={isLoading} className={`px-6 py-3 text-sm font-bold rounded-lg shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5 flex items-center justify-center space-x-2 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 ${ isLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-gradient-to-r from-green-500 to-emerald-600 text-white' }`}>{isLoading ? (<><IconSpinner /><span>Processing...</span></>) : (<><span>{currentStep === 3 ? 'Calculate Results' : 'Next Step'}</span>{currentStep < 3 && <IconChevronRight />}</>)}</button>
                                </div>
                            </footer>
                        )}
                    </div>
                    <TrustIndicators />
                </div>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<StrictMode><App /></StrictMode>);
    </script>
</body>
</html>

